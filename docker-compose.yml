version: "2"
services:
  db:
    restart: always
    image: postgres:9.4
    container_name: exchange_rates_postgres
    hostname: db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
  rabbit:
    restart: always
    hostname: rabbit
    container_name: exchange_rates_rabbit
    image: rabbitmq:3.6-management
    environment:
      - RABBITMQ_DEFAULT_USER=exchange
      - RABBITMQ_DEFAULT_PASS=Zasada123456789
    ports:
      - "5672"
      - "15672"
  web:
    restart: always
    build: .
    container_name: exchange_rates_web
    hostname: web
    command: ./run_web.sh
    volumes:
      - .:/app
    expose:
      - "8000"
    links:
      - db
      - rabbit
      - nginx
  worker_rates:
    build: .
    restart: always
    container_name: exchange_rates_worker_rates
    command: ./run_rates_worker.sh
    volumes:
      - .:/app
    links:
      - db
      - rabbit
  worker_notifications:
    build: .
    environment:
      - NOTIFICATIONS_EMAIL_PASSWORD=$NOTIFICATIONS_EMAIL_PASSWORD
      - NOTIFICATIONS_EMAIL_USER=$NOTIFICATIONS_EMAIL_USER
    restart: always
    container_name: exchange_rates_worker_notifiactions
    command: ./run_notifications_worker.sh
    volumes:
      - .:/app
    links:
      - db
      - rabbit
  shell:
    build: .
    environment:
      - NOTIFICATIONS_EMAIL_PASSWORD=$NOTIFICATIONS_EMAIL_PASSWORD
      - NOTIFICATIONS_EMAIL_USER=$NOTIFICATIONS_EMAIL_USER
    restart: always
    container_name: exchange_rates_shell
    command: tail -f /dev/null
    volumes:
      - .:/app
    links:
      - db
      - rabbit
  nginx:
    restart: always
    build: ./nginx/
    ports:
      - "80:80"
    volumes:
      - .:/app
